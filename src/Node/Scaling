; ğŸš€ Scaling Node.js Apps (Clustering, PM2, Workers)

; 1. Why Scaling is Needed
; 	â€¢	Node.js runs on a single thread â†’ can handle many requests (event loop + async I/O) but only uses one CPU core.
; 	â€¢	On multi-core machines, your app isnâ€™t fully utilizing hardware.
; 	â€¢	Scaling helps:
; 	â€¢	Handle more concurrent traffic.
; 	â€¢	Improve fault tolerance (if one process crashes, others survive).
; 	â€¢	Distribute workload.

; â¸»

; 2. Clustering
; 	â€¢	Clustering = running multiple instances of your Node.js app to utilize multiple CPU cores.
; 	â€¢	Nodeâ€™s built-in cluster module spawns worker processes that share the same server port.

; ğŸ”‘ Key points:
; 	â€¢	Master process â†’ spawns & manages workers.
; 	â€¢	Workers â†’ handle client requests.
; 	â€¢	Load balancing is handled internally (round-robin in recent Node versions).

; const cluster = require("cluster");
; const http = require("http");
; const os = require("os");

; if (cluster.isMaster) {
;   const numCPUs = os.cpus().length;
;   console.log(`Master ${process.pid} is running`);

;   // Fork workers
;   for (let i = 0; i < numCPUs; i++) {
;     cluster.fork();
;   }

;   cluster.on("exit", (worker) => {
;     console.log(`Worker ${worker.process.pid} died. Restarting...`);
;     cluster.fork();
;   });
; } else {
;   // Worker processes
;   http.createServer((req, res) => {
;     res.writeHead(200);
;     res.end(`Handled by worker ${process.pid}\n`);
;   }).listen(3000);

;   console.log(`Worker ${process.pid} started`);
; }
; âœ… Interview Highlight:
; â€œClustering lets Node.js apps scale across all CPU cores. The master process manages workers, and if one crashes, it can restart automatically.â€

; â¸»
; 3. PM2 (Process Manager 2)
; 	â€¢	Production-ready process manager for Node.js.
; 	â€¢	Handles:
; 	â€¢	Clustering
; 	â€¢	Auto-restarts on crash
; 	â€¢	Load balancing
; 	â€¢	Log management
; 	â€¢	Monitoring & metrics

; ğŸ“Œ Example commands:
; # Start in cluster mode using all CPU cores
; pm2 start app.js -i max

; # Start with 4 instances
; pm2 start app.js -i 4

; # Monitor processes
; pm2 monit

; # Restart if app crashes
; pm2 restart app

; # Save process config
; pm2 save

; âœ… Interview Highlight:
; â€œPM2 simplifies managing Node.js apps in production. It provides clustering, auto-restarts,
;  and monitoring out of the box, making it easy to keep apps running smoothly.â€



;  4. Worker Threads (vs Clustering)
; 	â€¢	Introduced in Node.js v10.5+, stable in v12+.
; 	â€¢	Workers allow multithreading in a single process.
; 	â€¢	Useful for CPU-intensive tasks (e.g., image processing, encryption, ML calculations).
; 	â€¢	Unlike clustering, workers share memory via SharedArrayBuffer.

; ğŸ“Œ Example:const { Worker, isMainThread, parentPort } = require("worker_threads");

; if (isMainThread) {
;   console.log("Main thread");
;   const worker = new Worker(__filename);
;   worker.on("message", msg => console.log("From worker:", msg));
;   worker.postMessage("Hello Worker!");
; } else {
;   parentPort.on("message", msg => {
;     parentPort.postMessage(`Worker received: ${msg}`);
;   });
; }
; âœ… Interview Highlight:
; â€œClustering scales across CPU cores for handling multiple requests, but Worker Threads are best when you need to offload CPU-heavy tasks without blocking the event loop.â€

; â¸»

; 5. When to Use What
;     â€¢	Clustering/PM2 â†’ Scale web servers to handle more concurrent requests.
;     â€¢	Worker Threads â†’ Offload CPU-intensive tasks within a single app instance.
;     â€¢	Both can be combined: Use PM2 for clustering and Worker Threads for heavy computations in each worker.

; â¸»
; ğŸ”¥ Interview Tricky Qs & Answers

; 	â€¢	Node.js is single-threaded, but we scale apps via clustering.
; 	â€¢	Cluster module â†’ creates multiple worker processes using all CPU cores.
; 	â€¢	PM2 â†’ process manager, makes clustering, monitoring, and restarts easy.
; 	â€¢	Worker Threads â†’ multithreading for CPU-heavy work, not request handling.
; 	â€¢	Common real-world combo: PM2 (clustering) + Worker Threads (CPU jobs).

; â¸»


; Q1: How to handle session data in a clustered Node.js app?
; 	â€¢ Use a centralized session store (e.g., Redis) to share session data across workers.

; Q2: When to use Worker Threads over Clustering?
; 	â€¢ Use Worker Threads for CPU-intensive tasks that need to run in parallel without blocking the event loop.
; 	â€¢ Use Clustering to handle more concurrent requests by utilizing multiple CPU cores.

; Q3: Can you use both Clustering and Worker Threads together?
; 	â€¢ Yes, you can use PM2 for clustering and Worker Threads for heavy computations in each worker.
